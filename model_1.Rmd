---
title: "Regression models trail for Ridership and Gas Price"
author: "Rita Li"
date: '2022-10-31'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Library and read in datasets
```{r,message=FALSE,echo=FALSE,warning=FALSE}
library(dbplyr)
library(tidyverse)
library(lubridate)
library(readr)
# for geeM studies
library(geeM)
library(tidyr)

library(dplyr)
library(broom)
library(ggplot2)
library(stringr)
library(splines)
library(astsa)


ridership<- read_csv("ridershipdata/ridership-route-day-Jan2014-Oct2017.csv")

gas <- read_csv("ridershipdata/Weekly_Minnesota_Regular_Conventional_Retail_Gasoline_Prices.csv", skip = 4)

nbhd <- read_csv("ridershipdata/stops_and_neighborhood.xls - TransitStops_Int_ExportTable.csv")
```

# prepare gas dataset
```{r, warning=FALSE}
gas_fixed <- gas %>% 
  mutate(date = as.Date(`Week of`, "%m/%d/%Y")) %>% 
  mutate(gas_price = `Weekly Minnesota Regular Conventional Retail Gasoline Prices Dollars per Gallon`) %>% 
  select(date, gas_price) %>% 
  mutate(month = month(date),year = year(date)) %>% 
  group_by(year,month) %>% 
  summarise(gas_price = mean(gas_price,na.rm = TRUE)) %>% 
  #filter(year > 2013 & year < 2018) %>% 
  ungroup() %>% 
  mutate(date = year + (month-1)/12)
```

# prepare Route Class dataset

```{r}
routeclass <- nbhd %>% 
  distinct(route, RouteClass)
```

# Join Datasets
```{r, fig.width=7,fig.height=3,message=FALSE}
rider_gas_complete <- ridership %>% 
  mutate(date = as.Date(dtDate)) %>%
  mutate(month = month(date),year = year(date)) %>% 
  group_by(Route,year,month) %>% 
  summarise(riders = sum(Total_Riders),RouteType) %>% 
  unique() %>% 
  right_join(gas_fixed, by = c("month","year")) %>% 
  ungroup()



coreloc <- rider_gas_complete %>% 
  right_join(routeclass, by = c("Route" = "route")) %>% 
  group_by(RouteClass, year, month) %>% 
  summarise(total_riders = mean(riders)) %>% 
  filter(RouteClass == "CoreLoc") %>% 
  mutate(date = year + (month-1)/12)
```


#CoreLoc

### Visualization of CoreLoc Ridership

```{r, fig.width=7,fig.height=3,message=FALSE}
coef <- 10000
CoreLoc %>% 
  ggplot(aes(x = date))+
  geom_line(aes(y = gas_price),color = "#9F2C2C")+
  geom_line(aes(y = total_riders/coef-10),color = "#3F4345")+ 
  scale_y_continuous(
    name = "Gas Price($)",
    sec.axis = sec_axis(trans = ~.*coef-10, name="Total Riders(thousands)"))+
  labs(title = "Change of Gas Price and Total Rides of all CoreLoc Routes over time",
       subtitle = "From Jan 2014 to Oct 2017")+
  geom_text(aes(x = 2017.5, y = 2.4), label = "Gas Price",color = "#9F2C2C",size = 3)+
  geom_text(aes(x = 2017.5, y = 1.7), label = "Total Riders",color = "#3F4345",size = 3)+
  theme_minimal()+
  theme(axis.title.y.left = element_text(color = "#9F2C2C",size = 12),
        axis.title.y.right = element_text(color = "#3F4345",size = 12),
        axis.text.y.left = element_text(color = "#9F2C2C",size = 8),
        axis.text.y.right = element_text(color = "#3F4345",size = 8),
        axis.title.x.bottom = element_blank(),
        plot.title = element_text(color = "#006bb3",size = 14),
        plot.subtitle = element_text(color = "#006bb3"))
```

### Fit factor(month) + gas_price Model for CoreLoc
```{r}
CoreLoc <- rider_gas_complete %>% 
  right_join(routeclass, by = c("Route" = "route")) %>% 
  group_by(RouteClass, year, month) %>% 
  summarise(total_riders = mean(riders),gas_price) %>% 
  filter(RouteClass == "CoreLoc") %>% 
  mutate(date = year + (month-1)/12) %>% 
  drop_na() %>%
  unique() %>% 
  ungroup()

lm.ride.season <- lm(total_riders ~ factor(month) + gas_price, data = CoreLoc)

CoreLoc$ride_predict <- predict(lm.ride.season)

CoreLoc$remove_season <- CoreLoc$total_riders-CoreLoc$ride_predict

lm.ride.season %>% summary()
```
```{r,fig.height=2,fig.width=4}
CoreLoc %>% 
  ggplot(aes(x = date, y = total_riders)) + 
  geom_line()+
  geom_line(aes(y = ride_predict),color = "blue",alpha = 0.3)+
  theme_minimal()+
  labs(title = "Time series of ridership of CoreLoc",
       x = "Date(numeric)",
       y = "Total Riders")
```

## timeseries for CoreLoc ridership

```{r}
# look at residuals
CoreLoc %>% 
  ggplot(aes(x = date, y = remove_season))+
  geom_line()+
  theme_minimal()
```

```{r}
acf2(na.omit(CoreLoc$remove_season)) 
```

If we take a look at the ACF(auto correlation function) and PACF(partial auto-correlation function) as shown below, we can see that the ACF gradually decays to 0, and the PACF seems to drop to 0 after lag 3. The patterns we observe here match the theoretical pattern of an AR model as the ACF gradually drops to 0 and the PACF seems to drop to 0 after a certain lag. Since the PACF seems to drop to 0 around after lag 2, we decided to fit an AR(3) model for the residuals.

```{r}
AR2 <- sarima(CoreLoc$remove_season, p = 3, d = 0, q = 0)
```
We think our model does a decent job at estimating our data as the ACF of residuals are fairly small, and the p-values for Ljung-Box test are fairly large, which implies our residuals are independent. 


# CommExpress

### Visualization
```{r, fig.width=7,fig.height=3,message=FALSE}
coef <- 4000
CommExpress %>% 
  # mutate(gas_price_normalized = (gas_price - mean(gas_price)/sd(gas_price)),
  #        riders_normalized = (total_riders - mean(total_riders))/sd(total_riders)) %>% 
  ggplot(aes(x = date))+
  geom_line(aes(y = gas_price),color = "#9F2C2C")+
  geom_line(aes(y = total_riders/coef-1),color = "#3F4345")+ 
  scale_y_continuous(
    name = "Gas Price($)",
    sec.axis = sec_axis(trans = ~.*coef-1, name="Total Riders"))+
  labs(title = "Change of Gas Price and Total Rides of all CommExpress Routes over time",
       subtitle = "From Jan 2014 to Oct 2017")+
  geom_text(aes(x = 2017.5, y = 2.1), label = "Gas Price",color = "#9F2C2C",size = 3)+
  geom_text(aes(x = 2017.5, y = 2.85), label = "Total Riders",color = "#3F4345",size = 3)+
  theme_minimal()+
  theme(axis.title.y.left = element_text(color = "#9F2C2C",size = 12),
        axis.title.y.right = element_text(color = "#3F4345",size = 12),
        axis.text.y.left = element_text(color = "#9F2C2C",size = 8),
        axis.text.y.right = element_text(color = "#3F4345",size = 8),
        axis.title.x.bottom = element_blank(),
        plot.title = element_text(color = "#006bb3",size = 14),
        plot.subtitle = element_text(color = "#006bb3"))
```

### Fit factor(month) + gas_price Model for CommExpress
```{r}
CommExpress <- rider_gas_complete %>% 
  right_join(routeclass, by = c("Route" = "route")) %>% 
  group_by(RouteClass, year, month) %>% 
  summarise(total_riders = mean(riders),gas_price) %>% 
  filter(RouteClass == "CommExpress") %>% 
  mutate(date = year + (month-1)/12) %>% 
  drop_na() %>% 
  unique() %>% 
  ungroup()

lm.ride.season <- lm(total_riders ~ factor(month) + gas_price, data = CommExpress)

CommExpress$ride_predict <- predict(lm.ride.season)

CommExpress$remove_season <- CommExpress$total_riders-CommExpress$ride_predict

lm.ride.season %>% summary()
```



## Other Models

### single vairable regression of each bus routes, riders and gas price, visualization of p-values
```{r}
routes <- r$Route %>% unique()
gasp <- gas$gas_price

betas <- c()
ses <- c()
tstats <- c()
pvals <- c()

# loop through all routes
a <- 0

for(i in routes){
  rides <- r %>% 
    filter(Route == i)
  ride <- rides$riders
  
  #fit the linear model
  mod <- lm(ride ~ gasp)
  # get coefficient information
  coefinfo <- tidy(mod)
  
  a <- a+1
  # record estimate, SE, test stat, and p-value
  betas[a] <- coefinfo$estimate[2]
  ses[a] <- coefinfo$std.error[2]
  tstats[a] <- coefinfo$statistic[2]
  pvals[a] <- coefinfo$p.value[2]
}

mod.results <- routes %>%
  as.data.frame() %>% 
  mutate(Estimate = betas,
         Std.Error = ses,
         Test.Statistic = tstats,
         P.Value = pvals)

mod.results %>% 
  mutate(sig = ifelse(P.Value <= 0.01,TRUE,FALSE)) %>% 
  mutate(positive = ifelse(Estimate > 0, TRUE, FALSE)) %>% 
  ggplot(aes(x = ., y = log(P.Value),shape = sig))+
  geom_point(aes(color = positive))
```

### zscore of ridership and gas price linear regression and prediction visualization
```{r}
justed_data <- rider_gas_complete %>% 
  group_by(Route) %>% 
  mutate(avg_riders = mean(riders),
         justed_riders = (riders-avg_riders)/sd(riders)) %>% 
  mutate(schedules = n()) %>%
  ungroup() %>% 
  filter(schedules == 44)

mod.justed <- justed_data %>% 
  lm(justed_riders ~ gas_price, data = .)

mod.justed %>% summary()

justed_data %>% 
  mutate(predict = predict(mod.justed),
         predict_riders = predict * sd(riders) + avg_riders) %>% 
  filter(Route == 63) %>% 
  ggplot(aes(x = date, y = riders))+
  geom_line()+
  geom_line(aes(y = predict_riders), color = "blue")
```

### zscore and gas price regression for each bus routes and visualization of p-values.
```{r}
routes <- justed_data$Route %>% unique()
gasp <- gas$gas_price

#gasp[1] <- 0

betas <- c()
ses <- c()
tstats <- c()
pvals <- c()

# loop through all routes
a <- 0

for(i in routes){
  rides <- justed_data %>% 
    filter(Route == i)
  ride <- rides$justed_riders
  
  #fit the linear model
  mod <- lm(ride ~ gasp)
  # get coefficient information
  coefinfo <- tidy(mod)
  
  a <- a+1
  # record estimate, SE, test stat, and p-value
  betas[a] <- coefinfo$estimate[2]
  ses[a] <- coefinfo$std.error[2]
  tstats[a] <- coefinfo$statistic[2]
  pvals[a] <- coefinfo$p.value[2]
}

mod.results <- routes %>%
  as.data.frame() %>% 
  mutate(Estimate = betas,
         Std.Error = ses,
         Test.Statistic = tstats,
         P.Value = pvals)

mod.results %>% 
  mutate(sig = ifelse(P.Value <= 0.05,TRUE,FALSE)) %>% 
  mutate(positive = ifelse(Estimate > 0, TRUE, FALSE)) %>% 
  ggplot(aes(x = ., y = log(P.Value),shape = sig))+
  geom_point(aes(color = positive))

```

# failed models
```{r, eval=FALSE}
ride63 <- rider_gas_complete %>%
  drop_na(riders, date) %>% 
  mutate(date_num = year + (month-1)/12) %>% 
  count(RouteType)
  ungroup()

lm.season <- lm(riders ~ factor(month), data = ride63)

ride63%>% 
  filter(Route == 84|Route == 63) %>% 
  ggplot(aes(x = date, y = riders, color = factor(Route))) + 
  geom_line()+
  geom_line(aes(y = gas_price*100),color = "black")


lm(riders ~ gas_price+factor(Route), data = ride63) %>% 
  summary()

ride63 %>% 
  geem(riders ~ gas_price, data = ., id = Route, corstr = "ar1") %>% 
  summary()

gas <- ride63 %>% 
  filter(Route == 63)

r <- ride63 %>% 
  group_by(Route) %>% 
  mutate(schedules = n()) %>%
  ungroup() %>% 
  filter(schedules == max(schedules))
```